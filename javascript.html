<script>
let currentUser = null;

window.onload = function() {
  const storedUser = localStorage.getItem('imgbuy_user');
  if(storedUser) {
    currentUser = JSON.parse(storedUser);
    setupDashboard();
    if(currentUser.isAdmin) document.getElementById('nav-admin').style.display = 'block';
  } else {
    // Load public leaderboard even if not logged in
    refreshDashboardData();
  }
};

function showView(viewId) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + viewId).classList.add('active');
  if(viewId === 'admin') loadAdminData();
}

function logout() {
  localStorage.removeItem('imgbuy_user');
  location.reload();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3000);
}

// --- IMAGE COMPRESSION LOGIC ---
function compressImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = event => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.getElementById('compress-canvas');
        const MAX_WIDTH = 1200; // Resize to reasonable width
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        // Compress to JPEG at 70% quality
        const dataUrl = canvas.toDataURL("image/jpeg", 0.7); 
        resolve(dataUrl);
      }
    };
    reader.onerror = error => reject(error);
  });
}

// --- CORE ACTIONS ---

async function handleSignup(e) {
  e.preventDefault();
  const btn = document.getElementById('btn-signup');
  btn.innerText = "Processing..."; btn.disabled = true;

  try {
    const fileInput = document.getElementById('s-qr');
    const qrBase64 = await compressImage(fileInput.files[0]); // Compress QR too

    const data = {
      name: document.getElementById('s-name').value,
      mobile: document.getElementById('s-mobile').value,
      email: document.getElementById('s-email').value,
      password: document.getElementById('s-pass').value,
      referral: document.getElementById('s-ref').value,
      qrFile: qrBase64,
      mimeType: "image/jpeg"
    };

    google.script.run.withSuccessHandler(res => {
      btn.innerText = "Sign Up"; btn.disabled = false;
      if(res.success) { alert(res.message); showView('login'); }
      else { showToast(res.message); }
    }).apiSignup(data);
  } catch(err) { btn.disabled = false; alert("Error processing image."); }
}

function handleLogin(e) {
  e.preventDefault();
  const btn = document.getElementById('btn-login');
  btn.innerText = "Checking...";
  
  google.script.run.withSuccessHandler(res => {
    btn.innerText = "Login";
    if(res.success) {
      currentUser = res;
      localStorage.setItem('imgbuy_user', JSON.stringify(res));
      setupDashboard();
      if(res.isAdmin) document.getElementById('nav-admin').style.display = 'block';
    } else { showToast(res.message); }
  }).apiLogin(document.getElementById('l-input').value, document.getElementById('l-pass').value);
}

async function handleUpload() {
  const fileInput = document.getElementById('u-file');
  if(fileInput.files.length === 0 || !document.getElementById('u-consent').checked) 
    return showToast("Select photo & agree to consent.");

  const btn = document.getElementById('btn-upload');
  btn.innerText = "Compressing & Uploading..."; btn.disabled = true;

  try {
    // COMPRESS BEFORE UPLOAD
    const base64 = await compressImage(fileInput.files[0]);
    
    const data = {
      userMobile: currentUser.token,
      fileBase64: base64,
      mimeType: "image/jpeg",
      category: document.getElementById('u-category').value
    };
    
    google.script.run.withSuccessHandler(res => {
      btn.innerText = "Upload"; btn.disabled = false;
      alert(res.message);
      refreshDashboardData();
    }).apiUploadImage(data);
  } catch(e) { alert("Error uploading."); btn.disabled = false; }
}

function setupDashboard() {
  document.getElementById('nav-login').style.display = 'none';
  document.getElementById('nav-dash').style.display = 'block';
  document.getElementById('nav-logout').style.display = 'block';
  document.getElementById('dash-welcome').innerText = "Hi, " + currentUser.name;
  document.getElementById('dash-ref-code').innerText = currentUser.token;
  showView('dashboard');
  refreshDashboardData();
}

function refreshDashboardData() {
  const mobile = currentUser ? currentUser.token : "";
  google.script.run.withSuccessHandler(data => {
    // 1. Update Leaderboard
    const lbEl = document.getElementById('leaderboard-list');
    if(data.leaderboard.length > 0) {
      lbEl.innerHTML = data.leaderboard.map((u, i) => `#${i+1} ${u.name} (₹${u.total})`).join("  |  ");
    }

    // 2. Update History (if logged in)
    if(currentUser) {
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = "";
      let totalEarn = 0;
      data.history.forEach(row => {
        totalEarn += parseInt(row.earnings) || 0;
        let color = row.status === 'Approved' ? 'green' : (row.status === 'Rejected' ? 'red' : 'orange');
        tbody.innerHTML += `<tr>
          <td>${row.date}</td>
          <td><span style="color:${color}">${row.status}</span><br><small>${row.comment}</small></td>
          <td>₹${row.earnings}</td>
        </tr>`;
      });
      document.getElementById('stat-count').innerText = data.history.length;
      document.getElementById('stat-earn').innerText = "₹" + totalEarn;
    }
  }).apiGetDashboard(mobile);
}

// --- ADMIN FUNCTIONS ---
function loadAdminData() {
  const grid = document.getElementById('admin-grid');
  grid.innerHTML = "Loading pending images...";
  
  google.script.run.withSuccessHandler(images => {
    grid.innerHTML = "";
    if(images.length === 0) grid.innerHTML = "No pending images.";
    
    images.forEach(img => {
      const card = document.createElement('div');
      card.className = 'admin-card';
      card.innerHTML = `
        <img src="${img.url}">
        <p>User: ${img.userMobile}</p>
        <p>Cat: ${img.category}</p>
        <input type="number" id="amt-${img.rowIndex}" placeholder="Price (₹)" value="10">
        <input type="text" id="com-${img.rowIndex}" placeholder="Comment (Optional)">
        <div class="admin-actions">
          <button class="btn-approve" onclick="processImg(${img.rowIndex}, 'APPROVE')">✔ Buy</button>
          <button class="btn-reject" onclick="processImg(${img.rowIndex}, 'REJECT')">❌ Reject</button>
        </div>
      `;
      grid.appendChild(card);
    });
  }).apiAdminGetPending();
}

function processImg(index, action) {
  const amount = document.getElementById('amt-'+index).value;
  const comment = document.getElementById('com-'+index).value;
  
  // Optimistic UI update (remove card immediately)
  event.target.closest('.admin-card').style.display = 'none';
  
  google.script.run.withSuccessHandler(res => {
    showToast("Processed Successfully");
  }).apiAdminProcess(index, action, amount, comment);
}
</script>
